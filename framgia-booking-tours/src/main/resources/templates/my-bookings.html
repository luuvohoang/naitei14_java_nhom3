<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Booking của tôi</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .badge-pending { background-color: #ffc107; color: #212529; }
        .badge-paid { background-color: #17a2b8; color: white; }
        .badge-confirmed { background-color: #28a745; color: white; }
        .badge-cancelled { background-color: #dc3545; color: white; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4">Danh sách Tour đã đặt</h2>

    <div th:if="${param.payment_status}" class="alert alert-info">
        <span th:if="${param.payment_status[0] == 'success'}">Thanh toán thành công!</span>
        <span th:if="${param.payment_status[0] == 'failed'}">Thanh toán thất bại hoặc bị hủy.</span>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <table class="table table-hover">
                <thead class="thead-dark">
                <tr>
                    <th>Mã đơn</th>
                    <th>Tour</th>
                    <th>Ngày đi</th>
                    <th>Số người</th>
                    <th>Tổng tiền</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="booking : ${bookings}">
                    <td th:text="${booking.id}">#123</td>
                    <td>
                        <strong th:text="${booking.tourName}">Tên Tour</strong><br>
                        <small th:text="${booking.tourLocation}">Địa điểm</small>
                    </td>
                    <td th:text="${booking.startDate}">2025-12-25</td>
                    <td th:text="${booking.numPeople}">2</td>
                    <td th:text="${#numbers.formatDecimal(booking.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">10,000,000 VNĐ</td>
                    <td>
                        <span class="badge p-2"
                              th:classappend="${'badge-' + booking.status.toLowerCase()}"
                              th:text="${booking.status}">PENDING</span>
                    </td>
                    <td>
                        <form th:if="${booking.status == 'PENDING'}"
                              th:action="@{/my-bookings/{id}/pay(id=${booking.id})}"
                              method="post" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-primary">Thanh toán</button>
                        </form>

                        <button th:if="${booking.status == 'PENDING' or booking.status == 'PAID'}"
                                class="btn btn-sm btn-outline-danger"
                                th:onclick="'cancelBooking(' + ${booking.id} + ')'">
                            Hủy
                        </button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(bookings)}">
                    <td colspan="7" class="text-center">Bạn chưa đặt tour nào.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <a href="/" class="btn btn-secondary">Quay lại trang chủ</a>
    </div>
</div>

<script>
    function cancelBooking(bookingId) {
        if (confirm('Bạn có chắc chắn muốn hủy tour này không?')) {
            // Gọi API Hủy
            fetch(`/api/bookings/${bookingId}/cancel`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                    // Nếu bạn dùng cơ chế token ở cookie hoặc session, browser tự gửi.
                    // Nếu dùng Bearer Token ở header, bạn cần code thêm logic lấy token từ localStorage để gắn vào đây.
                    // Tuy nhiên với MVC Controller, thường chúng ta dùng Session-based Auth.
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Đã hủy thành công!');
                        location.reload(); // Tải lại trang để cập nhật trạng thái
                    } else {
                        alert('Hủy thất bại. Vui lòng thử lại.');
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }
</script>

</body>
</html>